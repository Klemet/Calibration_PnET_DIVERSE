
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Setting up the calibration landscape (ecoregions, initial communities, climate etc.) &#8212; Calibration of PnET Succession for the DIVERSE project</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'StartingCalibrationTest/4.Setting_up_calibration_Landscape';</script>
    <link rel="canonical" href="https://klemet.github.io/Calibration_PnET_DIVERSE/intro.html/StartingCalibrationTest/4.Setting_up_calibration_Landscape.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Obtaining the growth data from the Forest Vegetation Simulator that will serve as reference for the calibration" href="5.Obtaining_Growth_data_from_FVS.html" />
    <link rel="prev" title="Initial species parameters" href="3.Initial_Species_Parameters.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/DIVERSE_PnET_Calibration_Logo.png" class="logo__image only-light" alt="Calibration of PnET Succession for the DIVERSE project - Home"/>
    <script>document.write(`<img src="../_static/DIVERSE_PnET_Calibration_Logo.png" class="logo__image only-dark" alt="Calibration of PnET Succession for the DIVERSE project - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    👋 Welcome !
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="Intro_CalibrationTest.html">Calibration test</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="1.Loading_functions.html">Loading functions and packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="2.Test_sim_functions.html">Making a test simulation to get used to the functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="3.Initial_Species_Parameters.html">Initial species parameters</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Setting up the calibration landscape (ecoregions, initial communities, climate etc.)</a></li>
<li class="toctree-l2"><a class="reference internal" href="5.Obtaining_Growth_data_from_FVS.html">Obtaining the growth data from the Forest Vegetation Simulator that will serve as reference for the calibration</a></li>
<li class="toctree-l2"><a class="reference internal" href="6.Monoculture_ideal_conditions.html">1st calibration step : Monoculture in ideal condition</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/Klemet/Calibration_PnET_DIVERSE" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/Klemet/Calibration_PnET_DIVERSE/issues/new?title=Issue%20on%20page%20%2FStartingCalibrationTest/4.Setting_up_calibration_Landscape.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/StartingCalibrationTest/4.Setting_up_calibration_Landscape.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Setting up the calibration landscape (ecoregions, initial communities, climate etc.)</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-climate-file">The climate file</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#climate-data-location-for-the-calibration">Climate data location for the calibration</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#climate-data-source-for-temperature-and-precipitation">Climate data source for 🌡️ temperature and 🌧️ precipitation</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#extraction-of-temperature-and-precipitation-data-for-ontario-1950-2100-from-candsc-m6">Extraction of 🌡 temperature and 🌧 precipitation data for Ontario, 1950-2100 from CanDSC-M6</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#climate-data-source-for-par-photosynthetically-active-radiation">Climate data source for ☀ PAR (Photosynthetically Active Radiation)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#climate-source-for-co2-concentrations">Climate source for ☁️ CO2 concentrations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#averaging-climate-data-in-constant-historical-averages">Averaging climate data in constant historical averages</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="setting-up-the-calibration-landscape-ecoregions-initial-communities-climate-etc">
<h1>Setting up the calibration landscape (ecoregions, initial communities, climate etc.)<a class="headerlink" href="#setting-up-the-calibration-landscape-ecoregions-initial-communities-climate-etc" title="Link to this heading">#</a></h1>
<p>Now that we have initial parameters for our species, we need to define the landscape in which the calibration will take place.</p>
<p>To adapt to the Python functions I’ve made for these Jupyter Notebooks (see <a class="reference download internal" download="" href="../_downloads/53d7d171bcfe75ee936a67526a50ff02/functionsForCalibration.py"><span class="xref download myst">here</span></a>), simulations will take place on a single cell.</p>
<p>What we need is :</p>
<ul class="simple">
<li><p>The climate file</p></li>
<li><p>The ecoregion file and PnET ecoregion parameters</p></li>
<li><p>Initial communities files</p></li>
</ul>
<section id="the-climate-file">
<h2>The climate file<a class="headerlink" href="#the-climate-file" title="Link to this heading">#</a></h2>
<p>See <a class="reference download internal" download="" href="../_downloads/0c3667e495cffb2731d2820363988a43/Gustafson2024PnETUserGuide.pdf"><span class="xref download myst">Gustafson and Miranda (2023)</span></a> for detailed information about what the climate file used in PnET simulations must contain.</p>
<p><a class="reference download internal" download="" href="../_downloads/0c3667e495cffb2731d2820363988a43/Gustafson2024PnETUserGuide.pdf"><span class="xref download myst">Gustafson and Miranda (2023)</span></a> recommends using a constant climate for calibrating (p. 69). Gustafson also recommends using an “ideal” climate at some points, but deciding what is an ideal climate for a given species is a difficult proposition. As we are going to compare the growth curves generated by PnET Succession with the growth curves generated by an empirical model like FVS (see <a class="reference internal" href="5.Obtaining_Growth_data_from_FVS.html"><span class="std std-doc">next section</span></a>), the idea will be rather to get long-term monthly averages (as recommanded by <a class="reference download internal" download="" href="../_downloads/0c3667e495cffb2731d2820363988a43/Gustafson2024PnETUserGuide.pdf"><span class="xref download myst">Gustafson and Miranda (2023)</span></a> p. 73) <strong>in the region of the FVS variant that we are going to use</strong> (or, if something else than FVS is used, long-term averages for the region where the empirical data comes from).</p>
<p>We have 5 variables that we need to gather :</p>
<ul class="simple">
<li><p>Maximum Monthly temperature (°C)</p></li>
<li><p>Minimum Monthly temperature (°C)</p></li>
<li><p>Photosynthetically Active Radiation (umol/m2/s)</p></li>
<li><p>Sum of precipitations during the month (mm)</p></li>
<li><p>Mean monthly atmospheric CO2 concentration (ppm)</p></li>
</ul>
<section id="climate-data-location-for-the-calibration">
<h3>Climate data location for the calibration<a class="headerlink" href="#climate-data-location-for-the-calibration" title="Link to this heading">#</a></h3>
<p>Since we’re doing calibration simulation here, we don’t have a particular place where our simulation take place. It’s up to us to choose where the climate data comes from, and there is not a “best” way to do things.</p>
<p>It’s surely most likely better to use climate conditions that are closer to the average of the conditions we want to simulate in other LANDIS-II simulation rather than to extremes (especially for this first step of calibration). We also want to make sure that the location we use ca be inputted in FVSon.</p>
<p>I propose that we use an area near the border between the boral and temperate forest, and near the center of Ontario. It will be arbitrary.</p>
<p>Here is a map from of the forests of Ontario from the 2016 forest report of Ontario :</p>
<p><img alt="" src="https://files.ontario.ca/1a-forestregion-map_e_1.png" /></p>
<p>The city of <a class="reference external" href="https://www.openstreetmap.org/#map=12/47.8416/-83.4106">Chapleau</a> seems to be located near the limit between the boreal and temperate forest. I created a simple shapefile polygon around the city that will serve to clip the climate data we want. See the next cell for a map.</p>
<div class="cell tag_hide_input tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Displays a map where the shapefile that defines the boundaries of the climate data we wanna use is</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">folium</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">folium.features</span><span class="w"> </span><span class="kn">import</span> <span class="n">GeoJsonPopup</span><span class="p">,</span> <span class="n">GeoJsonTooltip</span>

<span class="c1"># Load the shapefile</span>
<span class="c1"># Replace &#39;path_to_shapefile.shp&#39; with your actual shapefile path</span>
<span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;./ReferencesAndData/ChapleauBoundariesClimate.shp&quot;</span><span class="p">)</span>

<span class="c1"># Check the CRS (Coordinate Reference System) of the shapefile</span>
<span class="c1"># If not in WGS84 (EPSG:4326), reproject it</span>
<span class="k">if</span> <span class="n">gdf</span><span class="o">.</span><span class="n">crs</span> <span class="o">!=</span> <span class="s1">&#39;EPSG:4326&#39;</span><span class="p">:</span>
    <span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="s1">&#39;EPSG:4326&#39;</span><span class="p">)</span>

<span class="c1"># Create a map centered on the mean of the shapefile bounds</span>
<span class="n">center_lat</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">unary_union</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">y</span>
<span class="n">center_lon</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">unary_union</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">x</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="p">[</span><span class="n">center_lat</span><span class="p">,</span> <span class="n">center_lon</span><span class="p">],</span> <span class="n">zoom_start</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># Add the GeoJSON data to the map with some styling</span>
<span class="n">folium</span><span class="o">.</span><span class="n">GeoJson</span><span class="p">(</span>
    <span class="n">gdf</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Polygons&#39;</span><span class="p">,</span>
    <span class="n">style_function</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;fillColor&#39;</span><span class="p">:</span> <span class="s1">&#39;#ebcb8b&#39;</span><span class="p">,</span>
        <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;#2e3440&#39;</span><span class="p">,</span>
        <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;fillOpacity&#39;</span><span class="p">:</span> <span class="mf">0.4</span>
    <span class="p">}</span>
<span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="c1"># Add layer control</span>
<span class="n">folium</span><span class="o">.</span><span class="n">LayerControl</span><span class="p">()</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="c1"># Alternatively, you can use this simpler approach which works in newer versions of JupyterLab</span>
<span class="n">display</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_312/3234761923.py:16: DeprecationWarning: The &#39;unary_union&#39; attribute is deprecated, use the &#39;union_all()&#39; method instead.
  center_lat = gdf.unary_union.centroid.y
/tmp/ipykernel_312/3234761923.py:17: DeprecationWarning: The &#39;unary_union&#39; attribute is deprecated, use the &#39;union_all()&#39; method instead.
  center_lon = gdf.unary_union.centroid.x
</pre></div>
</div>
<div class="output text_html"><div style="width:100%;"><div style="position:relative;width:100%;height:0;padding-bottom:60%;"><span style="color:#565656">Make this Notebook Trusted to load map: File -> Trust Notebook</span><iframe srcdoc="&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    
    &lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=UTF-8&quot; /&gt;
    
        &lt;script&gt;
            L_NO_TOUCH = false;
            L_DISABLE_3D = false;
        &lt;/script&gt;
    
    &lt;style&gt;html, body {width: 100%;height: 100%;margin: 0;padding: 0;}&lt;/style&gt;
    &lt;style&gt;#map {position:absolute;top:0;bottom:0;right:0;left:0;}&lt;/style&gt;
    &lt;script src=&quot;https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js&quot;&gt;&lt;/script&gt;
    &lt;script src=&quot;https://code.jquery.com/jquery-3.7.1.min.js&quot;&gt;&lt;/script&gt;
    &lt;script src=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js&quot;&gt;&lt;/script&gt;
    &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js&quot;&gt;&lt;/script&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css&quot;/&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css&quot;/&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css&quot;/&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css&quot;/&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css&quot;/&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css&quot;/&gt;
    
            &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width,
                initial-scale=1.0, maximum-scale=1.0, user-scalable=no&quot; /&gt;
            &lt;style&gt;
                #map_83d9832b134ed9baffdf0cb54da6bef3 {
                    position: relative;
                    width: 100.0%;
                    height: 100.0%;
                    left: 0.0%;
                    top: 0.0%;
                }
                .leaflet-container { font-size: 1rem; }
            &lt;/style&gt;
        
&lt;/head&gt;
&lt;body&gt;
    
    
            &lt;div class=&quot;folium-map&quot; id=&quot;map_83d9832b134ed9baffdf0cb54da6bef3&quot; &gt;&lt;/div&gt;
        
&lt;/body&gt;
&lt;script&gt;
    
    
            var map_83d9832b134ed9baffdf0cb54da6bef3 = L.map(
                &quot;map_83d9832b134ed9baffdf0cb54da6bef3&quot;,
                {
                    center: [47.824934688075345, -83.36832547778936],
                    crs: L.CRS.EPSG3857,
                    ...{
  &quot;zoom&quot;: 10,
  &quot;zoomControl&quot;: true,
  &quot;preferCanvas&quot;: false,
}

                }
            );

            

        
    
            var tile_layer_6d4fea8d5ecb60b48d61b75ded2b7c79 = L.tileLayer(
                &quot;https://tile.openstreetmap.org/{z}/{x}/{y}.png&quot;,
                {
  &quot;minZoom&quot;: 0,
  &quot;maxZoom&quot;: 19,
  &quot;maxNativeZoom&quot;: 19,
  &quot;noWrap&quot;: false,
  &quot;attribution&quot;: &quot;\u0026copy; \u003ca href=\&quot;https://www.openstreetmap.org/copyright\&quot;\u003eOpenStreetMap\u003c/a\u003e contributors&quot;,
  &quot;subdomains&quot;: &quot;abc&quot;,
  &quot;detectRetina&quot;: false,
  &quot;tms&quot;: false,
  &quot;opacity&quot;: 1,
}

            );
        
    
            tile_layer_6d4fea8d5ecb60b48d61b75ded2b7c79.addTo(map_83d9832b134ed9baffdf0cb54da6bef3);
        
    
        function geo_json_2e63ac02faf41a87e700f7a3d957b995_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;#2e3440&quot;, &quot;fillColor&quot;: &quot;#ebcb8b&quot;, &quot;fillOpacity&quot;: 0.4, &quot;weight&quot;: 1};
            }
        }

        function geo_json_2e63ac02faf41a87e700f7a3d957b995_onEachFeature(feature, layer) {
            layer.on({
            });
        };
        var geo_json_2e63ac02faf41a87e700f7a3d957b995 = L.geoJson(null, {
                onEachFeature: geo_json_2e63ac02faf41a87e700f7a3d957b995_onEachFeature,
            
                style: geo_json_2e63ac02faf41a87e700f7a3d957b995_styler,
            ...{
}
        });

        function geo_json_2e63ac02faf41a87e700f7a3d957b995_add (data) {
            geo_json_2e63ac02faf41a87e700f7a3d957b995
                .addData(data);
        }
            geo_json_2e63ac02faf41a87e700f7a3d957b995_add({&quot;bbox&quot;: [-83.51730371900837, 47.738566201858305, -83.21934723657034, 47.91130317429239], &quot;features&quot;: [{&quot;bbox&quot;: [-83.51730371900837, 47.738566201858305, -83.21934723657034, 47.91130317429239], &quot;geometry&quot;: {&quot;coordinates&quot;: [[[-83.51730371900837, 47.738566201858305], [-83.51730371900837, 47.91130317429239], [-83.21934723657034, 47.91130317429239], [-83.21934723657034, 47.738566201858305], [-83.51730371900837, 47.738566201858305]]], &quot;type&quot;: &quot;Polygon&quot;}, &quot;id&quot;: &quot;0&quot;, &quot;properties&quot;: {&quot;AREA&quot;: 0.051468100693455, &quot;CNTX&quot;: -83.36832547778936, &quot;CNTY&quot;: 47.824934688075345, &quot;HEIGHT&quot;: 0.172736972434087, &quot;MAXX&quot;: -83.21934723657034, &quot;MAXY&quot;: 47.91130317429239, &quot;MINX&quot;: -83.51730371900837, &quot;MINY&quot;: 47.738566201858305, &quot;PERIM&quot;: 0.941386909744224, &quot;WIDTH&quot;: 0.297956482438025}, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
            geo_json_2e63ac02faf41a87e700f7a3d957b995.addTo(map_83d9832b134ed9baffdf0cb54da6bef3);
        
    
            var layer_control_3b81f8cb699db0578d50c3208709a41e_layers = {
                base_layers : {
                    &quot;openstreetmap&quot; : tile_layer_6d4fea8d5ecb60b48d61b75ded2b7c79,
                },
                overlays :  {
                    &quot;Polygons&quot; : geo_json_2e63ac02faf41a87e700f7a3d957b995,
                },
            };
            let layer_control_3b81f8cb699db0578d50c3208709a41e = L.control.layers(
                layer_control_3b81f8cb699db0578d50c3208709a41e_layers.base_layers,
                layer_control_3b81f8cb699db0578d50c3208709a41e_layers.overlays,
                {
  &quot;position&quot;: &quot;topright&quot;,
  &quot;collapsed&quot;: true,
  &quot;autoZIndex&quot;: true,
}
            ).addTo(map_83d9832b134ed9baffdf0cb54da6bef3);

        
&lt;/script&gt;
&lt;/html&gt;" style="position:absolute;width:100%;height:100%;left:0;top:0;border:none !important;" allowfullscreen webkitallowfullscreen mozallowfullscreen></iframe></div></div></div></div>
</div>
</section>
<section id="climate-data-source-for-temperature-and-precipitation">
<h3>Climate data source for 🌡️ temperature and 🌧️ precipitation<a class="headerlink" href="#climate-data-source-for-temperature-and-precipitation" title="Link to this heading">#</a></h3>
<p>There are many sources of climate data. However, in this documentation, we will want to access both historical data and future data based on different scenarios for the different steps of the calibration. As such, we need :</p>
<ul class="simple">
<li><p>Data for all of Canada (since we want to do simulations throughout Canada in the DIVERSE project)</p></li>
<li><p>Data that takes into account different Climate Models (e.g. ensemble data, percentiles, etc.) to take into account model variability</p></li>
<li><p>Data that gives predictions of maximum and minimum temperatures, along with monthly sums of precipitations</p></li>
<li><p>(Optional, but very useful) data that we can process easily through Python code to make things replicable.</p></li>
</ul>
<p>I’ve looked at several data sources (<a class="reference external" href="https://www.ncei.noaa.gov/access/metadata/landing-page/bin/iso?id=gov.noaa.ncdc:C00332">NclimGrid</a>, <a class="reference external" href="https://www.ncei.noaa.gov/products/land-based-station/global-historical-climatology-network-daily">here</a>, <a class="reference external" href="https://berkeleyearth.org/data/">here</a> etc.); but all were either just for the US, or just for historical data. We also have Worldclim and ClimateNA which are good, but of lesser quality from the one I choosed below.</p>
<p>In the end, the data from <a class="reference external" href="https://climatedata.ca/">climatedata.ca</a> was the most adapted. I contacted them, and they sent me links to their <a class="reference external" href="https://pavics.ouranos.ca/climate_analysis.html">very detailed documentation</a> allowing us to access their data with the OPeNDAP procotol, which avoids downloading the whole datasets - and make us able to access only the spatial/temporal chuncks we need.</p>
<p>The data we’re using here comes from the future projection dataset <a class="reference external" href="https://climatedata.ca/resource/intro-to-candcs-m6/">CanDSC-M6</a>, which contains downscaled data from several Global Climate Models with a state-of-the-art methodology. See the following cell for data extraction.</p>
<p>However, <strong>we are not going to use ensemble data</strong> (percentiles accross several climate models) from CanDSC-M6, but rather data from a single climate model. This is because variables like temperature and precipitation have a great variability from month to month or year to year. Some years can see droughts, some years can see more rain. If we use ensemble data, we take into account inter-variability, but we completly loose the intra-model variability - which is crucial to model the more extreme conditions we see in real life when compared to the very “mild” and very average values obtained through percentiles.</p>
<p>We can see it clearly on this figure, which I generated with previous version of code from this notebook. The blue curve is precipitation data from a single climate model run; the orange curve is percentile data accross 17 different climate models. Both curve have approximately the same mean/average; but the variability is very different, and much higher in data from a single run.</p>
<p><img alt="" src="../_images/Climate_Percentile_versus_SingleModel.png" /></p>
<p>As such, we’ll have to select one of the climate models whose data is available in CanDSC-M6. The idea is to select a model who’s output are closest to the concensus/average/median among models, so that we still take into account inter-model variability by avoiding models that are at the extremes of this variability.</p>
<p>The following code cell does this by computing a standardized mean squared error for all 26 models of CanDCS-M6 and our three variables (precipitations, Tmin, Tmax) when compared to the median accross all models. It returns the models that is closest to the median overall, not just for one variable.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># This cell takes the precipitation, min and max temp data from CanDCS-M6</span>
<span class="c1"># and finds the model closts to the median accross all three variables using a standardized mean squarred approach</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">functionsForCalibration</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">siphon.catalog</span><span class="w"> </span><span class="kn">import</span> <span class="n">TDSCatalog</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dask.diagnostics</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProgressBar</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">clisops.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">subset</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
    
<span class="c1"># These URLs was made by browsing the THREDD server catalog of datasets, as was recommanded to me by email by the Canadian Centre for Climate Services (ECCC</span>
<span class="c1"># It points to the location of monthly total precipitation, Monthly tmax and tmin data for CanDCS-M6, and climate scenario SSP126.</span>
<span class="c1"># Here, we are in a folder with 26 different .nc files, corresponding to different GCMs runs</span>
<span class="c1"># We will loop to display each of them on a plot</span>
<span class="c1"># We can choose the ssp scenario; CanDCS-M6 has ssp126 (1-2.6), ssp245 (2-4.5), ssp370 (3-7.0), and ssp 585 (5-8.5).</span>
<span class="n">sspScenario</span> <span class="o">=</span> <span class="s2">&quot;ssp126&quot;</span> <span class="c1"># We use 126 for now as we&#39;ll do the calibration on historical, averaged data in the end anyway.</span>
<span class="n">dictOfVariablesURL</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;prcptot&quot;</span><span class="p">:</span><span class="s2">&quot;https://pavics.ouranos.ca/twitcher/ows/proxy/thredds/catalog/birdhouse/disk2/cccs_portal/indices/Final/CanDCS-M6/prcptot/MS/&quot;</span> <span class="o">+</span> <span class="n">sspScenario</span> <span class="o">+</span> <span class="s2">&quot;/simulations/catalog.xml&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;tn_min&quot;</span><span class="p">:</span><span class="s2">&quot;https://pavics.ouranos.ca/twitcher/ows/proxy/thredds/catalog/birdhouse/disk2/cccs_portal/indices/Final/CanDCS-M6/tn_min/MS/&quot;</span> <span class="o">+</span> <span class="n">sspScenario</span> <span class="o">+</span> <span class="s2">&quot;/simulations/catalog.xml&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;tx_max&quot;</span><span class="p">:</span><span class="s2">&quot;https://pavics.ouranos.ca/twitcher/ows/proxy/thredds/catalog/birdhouse/disk2/cccs_portal/indices/Final/CanDCS-M6/tx_max/MS/&quot;</span> <span class="o">+</span> <span class="n">sspScenario</span> <span class="o">+</span> <span class="s2">&quot;/simulations/catalog.xml&quot;</span><span class="p">}</span>

<span class="n">dictOfResults</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">dictOfVariablesURL</span><span class="p">:</span>
    <span class="c1"># Create Catalog object</span>
    <span class="n">cat</span> <span class="o">=</span> <span class="n">TDSCatalog</span><span class="p">(</span><span class="n">dictOfVariablesURL</span><span class="p">[</span><span class="n">variable</span><span class="p">])</span>

    <span class="c1"># Create dictionnary to fill with values</span>
    <span class="n">variableMonthlyDict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">datasetID</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat</span><span class="o">.</span><span class="n">datasets</span><span class="p">)):</span>
        <span class="c1"># Selects the dataset</span>
        <span class="n">cds</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">datasetID</span><span class="p">]</span>
        <span class="c1"># Gets the model name from the .nc file name</span>
        <span class="n">modelName</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cds</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_historical+&quot;</span> <span class="o">+</span> <span class="n">sspScenario</span> <span class="o">+</span> <span class="s2">&quot;_1950-2100.nc&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">variable</span> <span class="o">+</span> <span class="s2">&quot;_mon_MBCn+PCIC-Blend_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="c1"># Get the data for the Chapleau area</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">cds</span><span class="o">.</span><span class="n">access_urls</span><span class="p">[</span><span class="s2">&quot;OPENDAP&quot;</span><span class="p">],</span> <span class="n">chunks</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>
        <span class="n">ds1</span> <span class="o">=</span> <span class="n">subset</span><span class="o">.</span><span class="n">subset_shape</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span>
                                  <span class="n">shape</span><span class="o">=</span><span class="s2">&quot;./ReferencesAndData/ChapleauBoundariesClimate.shp&quot;</span><span class="p">)</span>
        <span class="n">ds_months</span> <span class="o">=</span> <span class="n">ds1</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1812</span><span class="p">))</span>
        <span class="c1"># With this command, we can get the monthly averages across all cells in one very quick step</span>
        <span class="c1"># Instead of going from month to month with listOfPrecTotMonthly.append(float(testds.isel(time=month).mean().values))</span>
        <span class="c1"># Here, we use mean() to get the mean values accross all of the  cells in our polygon.</span>
        <span class="c1"># This works for precipitations too as mm are not dependent on the surface; 1mm of precipitation = 1l per m2. PnET takes</span>
        <span class="c1"># the same unit, so it&#39;s OK.</span>
        <span class="n">listOVariableMonthly</span> <span class="o">=</span> <span class="n">ds_months</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="c1"># We put the values in the dictionnary</span>
        <span class="n">variableMonthlyDict</span><span class="p">[</span><span class="n">modelName</span><span class="p">]</span> <span class="o">=</span> <span class="n">listOVariableMonthly</span>

    <span class="n">dictOfResults</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">variableMonthlyDict</span>

<span class="c1"># We create the list of years/months to plot</span>
<span class="n">years</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1950</span><span class="p">,</span> <span class="mi">2101</span><span class="p">),</span> <span class="mi">12</span><span class="p">)</span>
<span class="c1"># Create months 1-12 for each year</span>
<span class="n">months</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span> <span class="mi">2101</span><span class="o">-</span><span class="mi">1950</span><span class="p">)</span>
<span class="n">datesTime</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;-01&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">month</span><span class="p">,</span> <span class="n">year</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">months</span><span class="p">,</span> <span class="n">years</span><span class="p">)]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">bestModel</span><span class="p">,</span> <span class="n">modelScore</span> <span class="o">=</span> <span class="n">plot_climate_variables_with_moving_average</span><span class="p">(</span><span class="n">dictOfResults</span><span class="p">[</span><span class="s2">&quot;prcptot&quot;</span><span class="p">],</span> <span class="n">dictOfResults</span><span class="p">[</span><span class="s2">&quot;tx_max&quot;</span><span class="p">],</span> <span class="n">dictOfResults</span><span class="p">[</span><span class="s2">&quot;tn_min&quot;</span><span class="p">],</span> <span class="n">datesTime</span><span class="p">,</span> <span class="n">window_years</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/d92b6833cde10f42b5091da6d063f471a3eefffd3cb1dc300b4367116d471660.png" src="../_images/d92b6833cde10f42b5091da6d063f471a3eefffd3cb1dc300b4367116d471660.png" />
</div>
</div>
<p>This method allows us to select the model that fits in an automatized way, depending on the landscape we’re working on. This will be useful for the main simulations we will do afterward for DIVERSE.</p>
<p>Different SSP scenarios give different fits, but it seems pretty robust to the size of the moving window we’re using. But in the calibration, we’ll use historical data. So, let’s do it again for historical data :</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We will now do the same as before, but use only data from 1950-2010, meaning the 732 first months of the sample.</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="n">dictOfResults_SampleHistorical</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dictOfResults</span><span class="p">)</span>

<span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">dictOfResults_SampleHistorical</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">dictOfResults_SampleHistorical</span><span class="p">[</span><span class="n">variable</span><span class="p">]:</span>
        <span class="n">dictOfResults_SampleHistorical</span><span class="p">[</span><span class="n">variable</span><span class="p">][</span><span class="n">model</span><span class="p">]</span> <span class="o">=</span> <span class="n">dictOfResults_SampleHistorical</span><span class="p">[</span><span class="n">variable</span><span class="p">][</span><span class="n">model</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">732</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">bestModel</span><span class="p">,</span> <span class="n">modelScore</span> <span class="o">=</span> <span class="n">plot_climate_variables_with_moving_average</span><span class="p">(</span><span class="n">dictOfResults_SampleHistorical</span><span class="p">[</span><span class="s2">&quot;prcptot&quot;</span><span class="p">],</span>
                                                                        <span class="n">dictOfResults_SampleHistorical</span><span class="p">[</span><span class="s2">&quot;tx_max&quot;</span><span class="p">],</span>
                                                                        <span class="n">dictOfResults_SampleHistorical</span><span class="p">[</span><span class="s2">&quot;tn_min&quot;</span><span class="p">],</span>
                                                                        <span class="n">datesTime</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">732</span><span class="p">],</span> <span class="n">window_years</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/b32d7900776ca4de2a3a8a7bf9a56d87c8bdc7ed02f75a5f0b4a98d71380203d.png" src="../_images/b32d7900776ca4de2a3a8a7bf9a56d87c8bdc7ed02f75a5f0b4a98d71380203d.png" />
</div>
</div>
<p>However, as recommanded by <a class="reference download internal" download="" href="../_downloads/0c3667e495cffb2731d2820363988a43/Gustafson2024PnETUserGuide.pdf"><span class="xref download myst">Gustafson and Miranda (2023)</span></a>, we will transform these climate conditions into constant conditions (accross the year, but variable between month) to avoid confounding the first step of the calibration with extreme events.</p>
<section id="extraction-of-temperature-and-precipitation-data-for-ontario-1950-2100-from-candsc-m6">
<h4>Extraction of 🌡 temperature and 🌧 precipitation data for Ontario, 1950-2100 from <a class="reference external" href="https://climatedata.ca/resource/intro-to-candcs-m6/">CanDSC-M6</a><a class="headerlink" href="#extraction-of-temperature-and-precipitation-data-for-ontario-1950-2100-from-candsc-m6" title="Link to this heading">#</a></h4>
<p>The following cells are based on the documentation of Ouranos (the institution behind <a class="reference external" href="https://climatedata.ca/">climatedata.ca</a> and <a class="reference external" href="https://climatedata.ca/resource/intro-to-candcs-m6/">CanDSC-M6</a>) to access the data in Python.</p>
<p>They extract the climate variables (Tmax, Monthly Tmin, Sum of precipitations) at a monthly timestep for the different “cells” in the CanDSC-M6 (since the data is gridded on all of the earth), and then make a global value for the small landscape that we’re simulating (average of Tmin, Tmax and precipitation sum for across all cells for the month).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The code in this cell loads the functions needed to extract the climate data from the PAVIS database from Ouranos,</span>
<span class="c1"># using the CanDSC-M6 dataset</span>
<span class="c1"># We will use it to extract minimum and maximum monthly temp + total monthly precipitation for climate scenario SSP126</span>
<span class="c1"># The code in this cell will be re-used on other pages to generate the values for other climate scenarios</span>
<span class="c1"># Right now, it doesn&#39;t really matter since the first calibration step (monoculture in best conditions) will use</span>
<span class="c1"># historical data</span>

<span class="c1"># Importing the packages needed</span>
<span class="c1"># Siphon is used to connect to the data,</span>
<span class="c1"># xarray is used to manipulate the data objects</span>
<span class="c1"># The rest is for progress bars, utilities</span>
<span class="c1"># Clisops is used to subset the data based on a polygon</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functionsForCalibration</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">siphon.catalog</span><span class="w"> </span><span class="kn">import</span> <span class="n">TDSCatalog</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dask.diagnostics</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProgressBar</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">clisops.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">subset</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>

<span class="c1"># This function will help us define the URL to get the right dataset,</span>
<span class="c1"># corresponding to the right variable; the right SSP scenario; and the right model.</span>
<span class="c1"># This URL was made by browsing the THREDD server catalog of datasets, as was recommanded to me by email by the Canadian Centre for Climate Services (ECCC</span>
<span class="c1"># It points to the location of monthly maximum temperature data for CanDCS-M6, and climate scenario SSP126. The models are from CIMP6 from the IPCC.</span>
<span class="k">def</span><span class="w"> </span><span class="nf">getURLDatasetCanDCSM6</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">sspScenario</span><span class="p">,</span> <span class="n">climateModel</span><span class="p">):</span>

    <span class="s2">&quot;/ensemble_percentiles/tn_min_mon_MBCn+PCIC-Blend_historical+ssp126_1950-2100_percentiles.nc&quot;</span>

    <span class="s2">&quot;tx_max_mon_MBCn+PCIC-Blend_INM-CM5-0_historical+ssp126_1950-2100.nc&quot;</span>
    
    <span class="n">url</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;https://pavics.ouranos.ca/twitcher/ows/proxy/thredds/dodsC/birdhouse/disk2/cccs_portal/indices/Final/CanDCS-M6/&quot;</span>
           <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span>
           <span class="o">+</span> <span class="s2">&quot;/MS/&quot;</span>
           <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sspScenario</span><span class="p">)</span>
           <span class="o">+</span> <span class="s2">&quot;/simulations/&quot;</span>
           <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span>
           <span class="o">+</span> <span class="s2">&quot;_mon_MBCn+PCIC-Blend_&quot;</span>
           <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">climateModel</span><span class="p">)</span>
           <span class="o">+</span> <span class="s2">&quot;_historical+ssp126_1950-2100.nc&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">url</span>

<span class="c1"># Selector for the SSP scenario we want</span>
<span class="c1"># Here, we&#39;re looking for 1950-2010 historical data</span>
<span class="c1"># Therefore, it&#39;s not that much important. We will use SSP 1-2.6</span>
<span class="n">sspScenario</span> <span class="o">=</span> <span class="s2">&quot;ssp126&quot;</span>

<span class="c1"># We define the time period of the data we want and prepare the dataframe</span>
<span class="c1"># that we will export for PnET - that will ultimatily contain a monthly measure</span>
<span class="c1"># of Tmin, Tmax, Precpitations, CO2 and PAR for each months of each year</span>
<span class="c1"># Here, we want historical data; I limited to up to 2010 to get conditions</span>
<span class="c1"># not too influenced by climate changed. It&#39;s arbitrary.</span>
<span class="n">startYear</span> <span class="o">=</span> <span class="mi">1950</span>
<span class="n">endYear</span> <span class="o">=</span> <span class="mi">2010</span>
<span class="n">years</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">startYear</span><span class="p">,</span> <span class="n">endYear</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="mi">12</span><span class="p">)</span>
<span class="c1"># Create months 1-12 for each year</span>
<span class="n">months</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span> <span class="p">(</span><span class="n">endYear</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">startYear</span><span class="p">)</span>
<span class="c1"># Create DataFrame</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;Year&#39;</span><span class="p">:</span> <span class="n">years</span><span class="p">,</span>
    <span class="s1">&#39;Month&#39;</span><span class="p">:</span> <span class="n">months</span>
<span class="p">})</span>
<span class="n">numberOfMonths</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Month&quot;</span><span class="p">])</span>

<span class="c1">#################################################</span>
<span class="c1"># MAXIMUM MONTHLY TEMPERATURE</span>
<span class="c1">#################################################</span>
<span class="c1"># print(getURLDatasetCanDCSM6(&quot;tx_max&quot;,</span>
                            <span class="c1"># sspScenario,</span>
                            <span class="c1"># bestModel))</span>

<span class="c1"># This does not download the entire dataset, just the metadata and attributes describing the content.</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">getURLDatasetCanDCSM6</span><span class="p">(</span><span class="s2">&quot;tx_max&quot;</span><span class="p">,</span>
                                      <span class="n">sspScenario</span><span class="p">,</span>
                                      <span class="n">bestModel</span><span class="p">),</span>
                    <span class="n">chunks</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>

<span class="c1"># This prints information about the dataset</span>
<span class="c1"># display(ds)</span>

<span class="c1"># Subset the dataset by polygon</span>
<span class="c1"># What we get in ds1 is an array of grid cells with a third dimension corresponding to time</span>
<span class="c1"># Since there are 150 years + 12 months of the last year,</span>
<span class="c1"># this gives out 1812 possible timestep</span>
<span class="c1"># So, this third time dimension from 0 to 1811</span>
<span class="n">ds1</span> <span class="o">=</span> <span class="n">subset</span><span class="o">.</span><span class="n">subset_shape</span><span class="p">(</span>
    <span class="n">ds</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="s2">&quot;./ReferencesAndData/ChapleauBoundariesClimate.shp&quot;</span>
<span class="p">)</span> 

<span class="c1"># Plot a map of first timestep</span>
<span class="c1"># Here, &quot;time&quot; is the timestep month (from 0 to 1811)</span>
<span class="c1"># So this displays the maximum temperature for january of 1950 (month 0)</span>
<span class="c1"># in our subset/polygon and plots it</span>
<span class="c1"># a = ds1.tx_max_p50.isel(time=0).plot()</span>

<span class="c1"># We select the variable data and months we need - all of them</span>
<span class="c1"># 0 is january of 1950. numberOfMonths is the number of months from 1950, defined</span>
<span class="c1"># at the beginning of the cell.</span>
<span class="n">ds_months</span> <span class="o">=</span> <span class="n">ds1</span><span class="o">.</span><span class="n">tx_max</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">numberOfMonths</span><span class="p">))</span>
<span class="c1"># With this command, we can get the monthly averages across all cells in one very quick step</span>
<span class="n">listOfTmaxMonthly</span> <span class="o">=</span> <span class="n">kelvin_to_celsius</span><span class="p">(</span><span class="n">ds_months</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;Tmax&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">listOfTmaxMonthly</span>

<span class="c1">#################################################</span>
<span class="c1"># MINIMUM MONTHLY TEMPERATURE</span>
<span class="c1">#################################################</span>
<span class="c1"># We do the same as before, but for the minimum temperature recorded for the month</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">getURLDatasetCanDCSM6</span><span class="p">(</span><span class="s2">&quot;tn_min&quot;</span><span class="p">,</span>
                                          <span class="n">sspScenario</span><span class="p">,</span>
                                          <span class="n">bestModel</span><span class="p">),</span>
                     <span class="n">chunks</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>
<span class="c1"># Subset by polygon (small extent around the town of Chapleau, Ontario)</span>
<span class="n">ds1</span> <span class="o">=</span> <span class="n">subset</span><span class="o">.</span><span class="n">subset_shape</span><span class="p">(</span>
    <span class="n">ds</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="s2">&quot;./ReferencesAndData/ChapleauBoundariesClimate.shp&quot;</span>
<span class="p">)</span> 

<span class="c1"># We select the variable data and months we need - all of them</span>
<span class="n">ds_months</span> <span class="o">=</span> <span class="n">ds1</span><span class="o">.</span><span class="n">tn_min</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">numberOfMonths</span><span class="p">))</span>
<span class="c1"># With this command, we can get the monthly averages across all cells in one very quick step</span>
<span class="n">listOfTminMonthly</span> <span class="o">=</span> <span class="n">kelvin_to_celsius</span><span class="p">(</span><span class="n">ds_months</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="c1"># print(ds1)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;Tmin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">listOfTminMonthly</span>


<span class="c1">#################################################</span>
<span class="c1"># PRECIPITATIONS</span>
<span class="c1">#################################################</span>
<span class="c1"># We do the same as before, but for the sum of precipitations for each month</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">getURLDatasetCanDCSM6</span><span class="p">(</span><span class="s2">&quot;prcptot&quot;</span><span class="p">,</span>
                                          <span class="n">sspScenario</span><span class="p">,</span>
                                          <span class="n">bestModel</span><span class="p">),</span>
                     <span class="n">chunks</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>
<span class="c1"># Subset by polygon (small extent around the town of Chapleau, Ontario)</span>
<span class="n">ds1</span> <span class="o">=</span> <span class="n">subset</span><span class="o">.</span><span class="n">subset_shape</span><span class="p">(</span>
    <span class="n">ds</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="s2">&quot;./ReferencesAndData/ChapleauBoundariesClimate.shp&quot;</span>
<span class="p">)</span> 
<span class="c1"># We select the variable data and months we need - all of them</span>
<span class="n">ds_months</span> <span class="o">=</span> <span class="n">ds1</span><span class="o">.</span><span class="n">prcptot</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">numberOfMonths</span><span class="p">))</span>
<span class="c1"># With this command, we can get the monthly averages across all cells in one very quick step</span>
<span class="c1"># Here, we use mean() to get the mean total precipitations for all of the  cells in our polygon.</span>
<span class="c1"># Precipitations in mm are not dependent on the surface; 1mm of precipitation = 1l per m2. PnET takes</span>
<span class="c1"># the same unit, so it&#39;s OK.</span>
<span class="n">listOfPrecTotMonthly</span> <span class="o">=</span> <span class="n">ds_months</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;SumOfPrecipitations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">listOfPrecTotMonthly</span>


<span class="c1">#################################################</span>
<span class="c1"># EXPORT TO CSV</span>
<span class="c1">#################################################</span>
<span class="c1"># We output the dataframe to a .csv</span>
<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;./ReferencesAndData/dataFrameClimate.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     Year  Month       Tmax       Tmin  SumOfPrecipitations
0    1950      1   1.766656 -40.488547            82.018227
1    1950      2   3.891656 -30.540625           121.325523
2    1950      3   7.339594 -32.717703            53.020832
3    1950      4  22.693750 -14.910406            68.468750
4    1950      5  28.860406  -6.858344            51.800781
..    ...    ...        ...        ...                  ...
727  2010      8  30.714594   5.745844            59.013020
728  2010      9  26.756250   0.412500            78.882812
729  2010     10  25.725000  -6.327094            81.093750
730  2010     11  12.475000 -14.025000            73.684898
731  2010     12   8.402094 -23.025000            77.760414

[732 rows x 5 columns]
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="climate-data-source-for-par-photosynthetically-active-radiation">
<h3>Climate data source for ☀ PAR (Photosynthetically Active Radiation)<a class="headerlink" href="#climate-data-source-for-par-photosynthetically-active-radiation" title="Link to this heading">#</a></h3>
<p>Sadly, the CanDSC-M6 dataset used for Tmax, Tmin and Precipitations (see above) doesn’t contain PAR data. In fact, after a bit of research, very few global datasets seem to have solar radiation variables, especially for several scenarios of climate change (RCP or SSP scenarios) like we will need in the end for this calibration but also for beyong. For example, ClimateNA or World Clim both do not have solar radiation data.</p>
<p>However, another dataset available from Climate Change Canada has PAR values, that they call Downwelling Shortwave Radiation : it is called <a class="reference external" href="https://crd-data-donnees-rdc.ec.gc.ca/CDAS/products/CanLEADv1/Cannon%20et%20al.%20-%202022%20-%20Canadian%20Large%20Ensembles%20Adjusted%20Dataset%20version%201%20%20CanLEADv1.pdf">CanLEADv1</a>.</p>
<p>Problem is, CanLEADv1 doesn’t have the same structure as CanDSC-M6 and doesn’t cover many climat scenarios. It only has a “no forcing” scenario and a “RCp 8.5” scenario. Plus, it contains two sets 50 replicates based on two input/observed data, but without any ensemble percentile dataset available. Finally, it’s not available through the OpENDAP protocol used above - meaning we have to download the entire datasets to work with it (around 30GB for the files concerning Tmax, Tmin, precipitations and PAR for just one replicate).</p>
<p>Talking with the Canadian Center for Climate Services by email, they recommanded that we use only data from CanLEADv1, and simply use an “indexing” method on Global Warming achieved through the simulation rather than time to get the climate values we want. The method is detailed <a class="reference external" href="https://climate-scenarios.canada.ca/?page=CRBCPI-general-summary#5.4-development_of_warming_level-based_change_factors">here</a>, <a class="reference external" href="https://climate-scenarios.canada.ca/?page=buildings-report#2.3-communicating_uncertainty">here</a> and <a class="reference external" href="https://agupubs.onlinelibrary.wiley.com/doi/10.1002/2015GL063569">here</a>. Basically, we would only use CanLEADv1 data (also for temperatures and precipitation); and the values we would take from the dataset for a moment T in LANDIS-II would be indexed on a 31-years average value centered on a year where the °C of Global Warming is reached in the climate scenario we are simulating. I’m not entirely sure about this approach; I feel like we would loose a lot of the advantages of the CanDSC-M6 data by using CanLEADv1.</p>
<p>Instead, I set out to use CanLEADv1 data to make a Generalized Additive Model (GAM) to predict PAR (which is in CanLEADv1) from monthly minimum temperature, maximum temperature and total precipitation (three variables we can both obtain for CanDSC-M6 and CanLEADv1). After a bit of experimentation, the GAM that I was able to produce seemed to have a good predictive power. Monthly averaged daily PAR is a very cyclic variable, with only small variations in its peak values for winter and summer.</p>
<p>In particular, I’ve looked at the difference between the monthly PAR values we are getting with this approach, versus those that were in files sent to us by Brian Sturtevant’s team. They look very similar, although the amplitude of the variation of PAR throughout the year is higher in our case. This is very easy to understand : since the climate data I’m working with is higher in the north, then the values for summer and winter have more amplitude than in Minnesota where Brian’s team work (because the days in winter and summer are shorter and longer in the north, respectively). So, everything seems fine !</p>
<p>Below is the code to download CanLEADv1 data, clip the data for the area of interested, format it, create a GAM, diagnose it, and then produce predicted values of PAR based on the CanDCS-M6 data we took above for the area.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># First step : We&#39;re going to download the data from CanLEADv1 (which contain PAR values),</span>
<span class="c1"># and select only what is of interest to us (monthly values inside the polygon of the area</span>
<span class="c1"># we are simulating), then format the data into a dataframe we will use to create a GAM (Generalize Additive Model) afterwards.</span>
<span class="c1"># WARNING : The climate files from CanLEADv1 are temporarely downloaded one by one in the calibration folder, but are deleted when the operation</span>
<span class="c1"># is done, as they are very heavy (betwee 6-8 GB per file, and there are 4 files in total).</span>
<span class="c1"># The files are at https://crd-data-donnees-rdc.ec.gc.ca/CDAS/products/CanLEADv1/CanRCM4-EWEMBI-MBCn/r1_r1i1p1/, which</span>
<span class="c1"># corresponds to one of the 50 replicates of CanLEADv1 calibrated with the EWEMBI observational dataset.</span>
<span class="c1"># See https://crd-data-donnees-rdc.ec.gc.ca/CDAS/products/CanLEADv1 for readmes and documentation.</span>
<span class="c1"># WARNING : If a download fails, you can relaunch the cell. Downloads are done with Axel, which can re-start a download from where it was.</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functionsForCalibration</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="n">shapefile_Chapleau</span> <span class="o">=</span> <span class="s2">&quot;ReferencesAndData/ChapleauBoundariesClimate.shp&quot;</span>
<span class="n">canLEADv1_url</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;https://crd-data-donnees-rdc.ec.gc.ca/CDAS/products/CanLEADv1/CanRCM4-EWEMBI-MBCn/r1_r1i1p1/&quot;</span>

<span class="c1"># If the file resulting from this cell already exists, we</span>
<span class="c1"># propose to the user not to run the cell - in order to not</span>
<span class="c1"># download the large file. Helps for re-runs of the notebook.</span>
<span class="c1"># Right now, this code only runs if the dataframe already compiled with the</span>
<span class="c1"># data we need for the Chapleau area is not already there. That avoids downloading</span>
<span class="c1"># around 30GB of data.</span>
<span class="c1"># WARNING : You should delete dataInputForModel_CanLEADv1.csv and re-create it</span>
<span class="c1"># if you are trying to do this step for another area than Chapleau.</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;ReferencesAndData/dataInputForModel_CanLEADv1.csv&quot;</span><span class="p">):</span>
    <span class="c1"># confirmation = input(&quot;Do you want to run this cell? The dataframe is already here. Running the cell will re-download around 30GB of climate data to re-generate the dataframe. (yes/no): &quot;)</span>
    <span class="c1"># if confirmation.lower() == &quot;yes&quot; or confirmation.lower() == &quot;y&quot;:</span>
    <span class="c1"># We start with the minimum temperature</span>
    <span class="c1"># We don&#39;t do it if the variable we need is already there</span>
    <span class="k">if</span> <span class="s1">&#39;tasmin_monthly&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
        <span class="c1"># We download the file</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;tasminAdjust_NAM-44i_CCCma-CanESM2_rcp85_r1_r1i1p1_CCCma-CanRCM4_r2_ECCC-MBCn-EWEMBI-1981-2010_day_19500101-21001231.nc&quot;</span>
        <span class="n">download_file</span><span class="p">(</span><span class="n">canLEADv1_url</span> <span class="o">+</span> <span class="n">file_name</span><span class="p">,</span>
                      <span class="n">file_name</span><span class="p">)</span>
        <span class="c1"># We select only the data pertinent to our needs</span>
        <span class="n">tasmin_ds</span> <span class="o">=</span> <span class="n">load_and_filter_by_polygon_canLEADv1</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">shapefile_Chapleau</span><span class="p">)</span>
        <span class="c1"># Transforming temperatures from kelvins to celcius</span>
        <span class="n">tasmin_ds</span><span class="p">[</span><span class="s2">&quot;tasminAdjust&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kelvin_to_celsius</span><span class="p">(</span><span class="n">tasmin_ds</span><span class="p">[</span><span class="s2">&quot;tasminAdjust&quot;</span><span class="p">])</span> 
        <span class="c1"># Resampling to monthly data</span>
        <span class="n">tasmin_monthly</span> <span class="o">=</span> <span class="n">tasmin_ds</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s1">&#39;1ME&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="c1"># Free up memory</span>
        <span class="k">del</span> <span class="n">tasmin_ds</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Variable tasmin_monthly exists, skipping download&quot;</span><span class="p">)</span>
    
    <span class="c1"># Now with the maximum temperature</span>
    <span class="k">if</span> <span class="s1">&#39;tasmax_monthly&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
        <span class="c1"># We download the file</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;tasmaxAdjust_NAM-44i_CCCma-CanESM2_rcp85_r1_r1i1p1_CCCma-CanRCM4_r2_ECCC-MBCn-EWEMBI-1981-2010_day_19500101-21001231.nc&quot;</span>
        <span class="n">download_file</span><span class="p">(</span><span class="n">canLEADv1_url</span> <span class="o">+</span> <span class="n">file_name</span><span class="p">,</span>
                      <span class="n">file_name</span><span class="p">)</span>
        <span class="c1"># We select only the data pertinent to our needs</span>
        <span class="n">tasmax_ds</span> <span class="o">=</span> <span class="n">load_and_filter_by_polygon_canLEADv1</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">shapefile_Chapleau</span><span class="p">)</span>
        <span class="c1"># Transforming temperatures from kelvins to celcius</span>
        <span class="n">tasmax_ds</span><span class="p">[</span><span class="s2">&quot;tasmaxAdjust&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kelvin_to_celsius</span><span class="p">(</span><span class="n">tasmax_ds</span><span class="p">[</span><span class="s2">&quot;tasmaxAdjust&quot;</span><span class="p">])</span>
        <span class="c1"># Resampling to monthly data</span>
        <span class="n">tasmax_monthly</span> <span class="o">=</span> <span class="n">tasmax_ds</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s1">&#39;1ME&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="c1"># Free up memory</span>
        <span class="k">del</span> <span class="n">tasmax_ds</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Variable tasmax_monthly exists, skipping download&quot;</span><span class="p">)</span>
    
    <span class="c1"># Now with the precipitations</span>
    <span class="k">if</span> <span class="s1">&#39;pr_monthly&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
        <span class="c1"># We download the file</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;prAdjust_NAM-44i_CCCma-CanESM2_rcp85_r1_r1i1p1_CCCma-CanRCM4_r2_ECCC-MBCn-EWEMBI-1981-2010_day_19500101-21001231.nc&quot;</span>
        <span class="n">download_file</span><span class="p">(</span><span class="n">canLEADv1_url</span> <span class="o">+</span> <span class="n">file_name</span><span class="p">,</span>
                      <span class="n">file_name</span><span class="p">)</span>
        <span class="c1"># We select only the data pertinent to our needs</span>
        <span class="n">pr_ds</span> <span class="o">=</span> <span class="n">load_and_filter_by_polygon_canLEADv1</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">shapefile_Chapleau</span><span class="p">)</span>
        <span class="c1"># Transforming precipitations from their original unit - kg m-2 s-1 - into mm per day</span>
        <span class="n">pr_ds</span><span class="p">[</span><span class="s2">&quot;prAdjust&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pr_ds</span><span class="p">[</span><span class="s2">&quot;prAdjust&quot;</span><span class="p">]</span><span class="o">*</span><span class="mi">86400</span> <span class="c1"># Going from seconds to days (86400 seconds in a day)</span>
        <span class="c1"># kg m-2 is already mm. So, we successfully went from kg m-2 s-1 to mm/day.</span>
        <span class="c1"># Resampling to monthly data</span>
        <span class="n">pr_monthly</span> <span class="o">=</span> <span class="n">pr_ds</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s1">&#39;1ME&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="c1"># Free up memory</span>
        <span class="k">del</span> <span class="n">pr_ds</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Variable pr_monthly exists, skipping download&quot;</span><span class="p">)</span>
    
    <span class="c1"># We finish with PAR (downwelling shortwave radiation, or rsds in CanLEADv1)</span>
    <span class="k">if</span> <span class="s1">&#39;rsds_monthly&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
        <span class="c1"># We download the file</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;rsdsAdjust_NAM-44i_CCCma-CanESM2_rcp85_r1_r1i1p1_CCCma-CanRCM4_r2_ECCC-MBCn-EWEMBI-1981-2010_day_19500101-21001231.nc&quot;</span>
        <span class="n">download_file</span><span class="p">(</span><span class="n">canLEADv1_url</span> <span class="o">+</span> <span class="n">file_name</span><span class="p">,</span>
                      <span class="n">file_name</span><span class="p">)</span>
        <span class="c1"># We select only the data pertinent to our needs</span>
        <span class="n">rsds_ds</span> <span class="o">=</span> <span class="n">load_and_filter_by_polygon_canLEADv1</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">shapefile_Chapleau</span><span class="p">)</span>
        <span class="c1"># Transforming downwelling shortwave radiation from W/m2 to umol.m2/s-1</span>
        <span class="c1"># This one is a complex one. PnET user guide says that if the measure in W/m2 FOR SHORTWAVE (400-700nm), then just multiply it by 4.57.</span>
        <span class="c1"># However, if W/m2 measure is for TOTAL solar radiation, then we need another conversion factor to go to the shorwave + umol. See User Guide for more.</span>
        <span class="c1"># Here, we&#39;re normally in shortwave. I&#39;ll confirm by comparing the values to other measurement in PnET climate files.</span>
        <span class="n">rsds_ds</span><span class="p">[</span><span class="s2">&quot;rsdsAdjust&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rsds_ds</span><span class="p">[</span><span class="s2">&quot;rsdsAdjust&quot;</span><span class="p">]</span><span class="o">*</span><span class="mf">4.57</span>
        <span class="c1"># Resampling to monthly data</span>
        <span class="n">rsds_monthly</span> <span class="o">=</span> <span class="n">rsds_ds</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s1">&#39;1ME&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="c1"># Free up memory</span>
        <span class="k">del</span> <span class="n">rsds_ds</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Variable rsds_monthly exists, skipping download&quot;</span><span class="p">)</span>
    
    <span class="c1"># We end up by preparign the data for making the GAM</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Preparing data for GAM...&quot;</span><span class="p">)</span>
    <span class="c1"># Create a DataFrame for each variable</span>
    <span class="n">tasmin_df</span> <span class="o">=</span> <span class="n">tasmin_monthly</span><span class="p">[</span><span class="s2">&quot;tasminAdjust&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">tasmax_df</span> <span class="o">=</span> <span class="n">tasmax_monthly</span><span class="p">[</span><span class="s2">&quot;tasmaxAdjust&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">pr_df</span> <span class="o">=</span> <span class="n">pr_monthly</span><span class="p">[</span><span class="s2">&quot;prAdjust&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">rsds_df</span> <span class="o">=</span> <span class="n">rsds_monthly</span><span class="p">[</span><span class="s2">&quot;rsdsAdjust&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    
    <span class="c1"># Merge DataFrames</span>
    <span class="n">merged_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tasmin_df</span><span class="p">,</span> <span class="n">tasmax_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">])</span>
    <span class="n">merged_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">merged_df</span><span class="p">,</span> <span class="n">pr_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">])</span>
    <span class="n">merged_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">merged_df</span><span class="p">,</span> <span class="n">rsds_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">])</span>
    
    <span class="c1"># Put time in time format</span>
    <span class="n">merged_df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">convert_cftime_to_datetime</span><span class="p">)</span>
    <span class="n">merged_df</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">merged_df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>
    
    <span class="c1"># Extract month as a feature</span>
    <span class="n">merged_df</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span>
    
    <span class="c1"># Drop rows with NaN values</span>
    <span class="n">merged_df</span> <span class="o">=</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    
    <span class="c1"># Export the file</span>
    <span class="n">merged_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;ReferencesAndData/dataInputForModel_CanLEADv1.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Climate data for the GAM has been properly created and exported. See ReferencesAndData/dataInputForModel_CanLEADv1.csv&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># Code to run if the user doesn&#39;t confirm</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cell execution cancelled - dataInputForModel_CanLEADv1 was already there.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cell execution cancelled - dataInputForModel_CanLEADv1 was already there.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Second step : Now that we have the data ready to use, we can fit a GAM to predict PAR (rsds) relative to temperature and precipitation and month</span>
<span class="c1"># We take the opportunity to create several plots to diagnose the performance of the GAM</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pygam</span><span class="w"> </span><span class="kn">import</span> <span class="n">GAM</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">te</span><span class="p">,</span> <span class="n">f</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="kn">import</span> <span class="n">Normalize</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.cm</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="c1"># Fit GAM model</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reading climate data from CanLEADv1&quot;</span><span class="p">)</span>
<span class="n">merged_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;ReferencesAndData/dataInputForModel_CanLEADv1.csv&#39;</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[[</span><span class="s1">&#39;tasminAdjust&#39;</span><span class="p">,</span> <span class="s1">&#39;tasmaxAdjust&#39;</span><span class="p">,</span> <span class="s1">&#39;prAdjust&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">]]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[</span><span class="s1">&#39;rsdsAdjust&#39;</span><span class="p">]</span>

<span class="c1"># Define the GAM model</span>
<span class="c1"># Here, with interactions : https://r.qcbs.ca/workshop08/book-en/gam-with-interaction-terms.html</span>
<span class="c1"># Assuming X is your feature matrix and y is your target variable</span>
<span class="c1"># Create weights that emphasize higher values</span>
<span class="n">weights</span> <span class="o">=</span> <span class="n">y</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

<span class="c1"># Create a GAM with appropriate terms for periodic data</span>
<span class="c1"># This is the best one I got so far in terms of AIC and normal distribution of the residuals.</span>
<span class="n">gam</span> <span class="o">=</span> <span class="n">GAM</span><span class="p">(</span>
    <span class="c1"># Use standard smooth terms with higher n_splines for flexibility</span>
    <span class="n">s</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span>

    <span class="c1"># For interaction terms</span>
    <span class="n">te</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
    <span class="n">te</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
	<span class="n">te</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span>
	<span class="n">te</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span>

    <span class="c1"># Add individual smooth terms</span>
    <span class="n">s</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
    <span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span>

    <span class="c1"># Keep the categorical variable</span>
    <span class="n">f</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>

    <span class="n">distribution</span><span class="o">=</span><span class="s1">&#39;gamma&#39;</span><span class="p">,</span>
    <span class="n">link</span><span class="o">=</span><span class="s1">&#39;log&#39;</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fitting GAM model...&quot;</span><span class="p">)</span>
<span class="c1"># Fit the model with the weights</span>
<span class="n">gam</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>

<span class="c1"># Print summary</span>
<span class="nb">print</span><span class="p">(</span><span class="n">gam</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>

<span class="c1"># Make predictions</span>
<span class="n">merged_df</span><span class="p">[</span><span class="s1">&#39;rsds_pred&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gam</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

<span class="c1"># Calculate R-squared</span>
<span class="n">r_squared</span> <span class="o">=</span> <span class="n">gam</span><span class="o">.</span><span class="n">statistics_</span><span class="p">[</span><span class="s1">&#39;pseudo_r2&#39;</span><span class="p">][</span><span class="s1">&#39;explained_deviance&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;R-squared: </span><span class="si">{</span><span class="n">r_squared</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Plot results for 5 random locations</span>
<span class="n">unique_locations</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[[</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_locations</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
    <span class="n">selected_locations</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">unique_locations</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_locations</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">selected_locations</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">unique_locations</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">selected_locations</span><span class="p">):</span>
    <span class="n">location_data</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[(</span><span class="n">merged_df</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">lat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">merged_df</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">lon</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">location_data</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No data found for location </span><span class="si">{</span><span class="n">lat</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">lon</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">continue</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">location_data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">location_data</span><span class="p">[</span><span class="s1">&#39;rsdsAdjust&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Actual RSDS&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">location_data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">location_data</span><span class="p">[</span><span class="s1">&#39;rsds_pred&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predicted RSDS&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;RSDS (W/m²)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Actual vs Predicted RSDS at Lat: </span><span class="si">{</span><span class="n">lat</span><span class="si">}</span><span class="s1">, Lon: </span><span class="si">{</span><span class="n">lon</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="c1"># plt.savefig(f&#39;plots/rsds_prediction_location_{i+1}.png&#39;, dpi = 300)</span>
    <span class="c1"># plt.close()</span>

<span class="c1"># Plot residuals</span>
<span class="c1"># Calculate residuals</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">gam</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">residuals</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">predictions</span>
<span class="c1"># Create directory for plots if it doesn&#39;t exist</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;plots&#39;</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s1">&#39;plots&#39;</span><span class="p">)</span>
<span class="c1"># Plot 1: Residuals vs Predicted values</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Predicted RSDS (W/m²)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Residuals&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Residuals vs Predicted Values&#39;</span><span class="p">)</span>
<span class="c1"># plt.savefig(&#39;plots/residuals_vs_predicted.png&#39;)</span>
<span class="c1"># plt.close()</span>
<span class="c1"># Plot 2: Histogram of residuals</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Residual Value&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Histogram of Residuals&#39;</span><span class="p">)</span>
<span class="c1"># plt.savefig(&#39;plots/residuals_histogram.png&#39;)</span>
<span class="c1"># plt.close()</span>
<span class="c1"># Plot 3: QQ plot of residuals</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">stats</span>
<span class="n">stats</span><span class="o">.</span><span class="n">probplot</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s2">&quot;norm&quot;</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">plt</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Q-Q Plot of Residuals&#39;</span><span class="p">)</span>
<span class="c1"># plt.savefig(&#39;plots/residuals_qq_plot.png&#39;)</span>
<span class="c1"># plt.close()</span>
<span class="c1"># Plot 4: Residuals vs each predictor</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Min Temperature&#39;</span><span class="p">,</span> <span class="s1">&#39;Max Temperature&#39;</span><span class="p">,</span> <span class="s1">&#39;Precipitation&#39;</span><span class="p">,</span> <span class="s1">&#39;Month&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">feature</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">feature_names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Residuals&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Residuals vs </span><span class="si">{</span><span class="n">feature_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># plt.savefig(f&#39;plots/residuals_vs_{feature}.png&#39;)</span>
    <span class="c1"># plt.close()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Reading climate data from CanLEADv1
Fitting GAM model...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>GAM                                                                                                       
=============================================== ==========================================================
Distribution:                         GammaDist Effective DoF:                                     77.5207
Link Function:                          LogLink Log Likelihood:                                 -9250.9289
Number of Samples:                         1812 AIC:                                            18658.8993
                                                AICc:                                           18666.1075
                                                GCV:                                                0.0052
                                                Scale:                                              0.0047
                                                Pseudo R-Squared:                                    0.981
==========================================================================================================
Feature Function                  Lambda               Rank         EDoF         P &gt; x        Sig. Code   
================================= ==================== ============ ============ ============ ============
s(0)                              [0.6]                20           14.1         1.91e-07     ***         
te(0, 2)                          [0.6 0.6]            100          21.4         1.11e-16     ***         
te(1, 2)                          [0.6 0.6]            100          15.7         1.11e-16     ***         
te(0, 3)                          [0.6 0.6]            100          15.0         1.11e-16     ***         
te(1, 3)                          [0.6 0.6]            100          7.2          1.11e-16     ***         
s(1)                              [0.6]                20           1.9          7.12e-12     ***         
s(2)                              [0.6]                20           2.2          9.55e-15     ***         
f(3)                              [0.6]                12           0.0          1.11e-16     ***         
intercept                                              1            0.0          1.11e-16     ***         
==========================================================================================================
Significance codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1

WARNING: Fitting splines and a linear function to a feature introduces a model identifiability problem
         which can cause p-values to appear significant when they are not.

WARNING: p-values calculated in this manner behave correctly for un-penalized models or models with
         known smoothing parameters, but when smoothing parameters have been estimated, the p-values
         are typically lower than they should be, meaning that the tests reject the null too readily.
None
R-squared: 0.9809865438341553
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_312/3196556276.py:52: UserWarning: KNOWN BUG: p-values computed in this summary are likely much smaller than they should be. 
 
Please do not make inferences based on these values! 

Collaborate on a solution, and stay up to date at: 
github.com/dswah/pyGAM/issues/163 

  print(gam.summary())
</pre></div>
</div>
<img alt="../_images/5536ac50d808e8d84b3c1f1ef44a14900404fc9cdc1682d3a338c698286ccc13.png" src="../_images/5536ac50d808e8d84b3c1f1ef44a14900404fc9cdc1682d3a338c698286ccc13.png" />
<img alt="../_images/2677bd0eba4c0d6e19d4da1d4ceebf8851b15ff10604196d0f74b95ecf48d38b.png" src="../_images/2677bd0eba4c0d6e19d4da1d4ceebf8851b15ff10604196d0f74b95ecf48d38b.png" />
<img alt="../_images/92e38d0536e329fc377df03132e6dff532051bc1cc259f47ca5ef7701c7d89bb.png" src="../_images/92e38d0536e329fc377df03132e6dff532051bc1cc259f47ca5ef7701c7d89bb.png" />
<img alt="../_images/2e0c1caf685aca5da9005c00547a9249086262af1d21fca8b86fc34c79c93373.png" src="../_images/2e0c1caf685aca5da9005c00547a9249086262af1d21fca8b86fc34c79c93373.png" />
<img alt="../_images/1b85e7c0218989265c56ac5fe4ae2f050b18dfb451615833573c617b2eefe767.png" src="../_images/1b85e7c0218989265c56ac5fe4ae2f050b18dfb451615833573c617b2eefe767.png" />
<img alt="../_images/d31bdd83c47dbe34de13e89506128c70f0f94dc57f1d735059bb2b0e868d96e5.png" src="../_images/d31bdd83c47dbe34de13e89506128c70f0f94dc57f1d735059bb2b0e868d96e5.png" />
<img alt="../_images/e153ecde71fca25775d45d34a1d9e3c745fcc4e7bf44133a5f66099cfb89b7b1.png" src="../_images/e153ecde71fca25775d45d34a1d9e3c745fcc4e7bf44133a5f66099cfb89b7b1.png" />
<img alt="../_images/cdcd7f701f18a590ff323c4b521f28d25338effb1981760b6a4ab7d365ce6f53.png" src="../_images/cdcd7f701f18a590ff323c4b521f28d25338effb1981760b6a4ab7d365ce6f53.png" />
</div>
</div>
<p>Concerning the diagnostic of the GAM : we can see that the predicted values are very close to the observed values. Residuals are overall distributed normally, but are higher for certains months (summer) and for low precipitation/high temperatures (surely a correlation to summer). It makes sense since the values of PAR are much higher and variable in the summer - which results in higher residuals. These tendancies are also observed on larger areas than the one that we are dealing with here.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Third step : we use the GAM to predict PAR from the temperature and precipitation data that we took from CanDSC-M6 earlier.</span>
<span class="c1"># Run the previous cell before running this one</span>

<span class="n">df_climateData</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;ReferencesAndData/dataFrameClimate.csv&#39;</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">df_climateData</span><span class="p">[[</span><span class="s1">&#39;Tmin&#39;</span><span class="p">,</span> <span class="s1">&#39;Tmax&#39;</span><span class="p">,</span> <span class="s1">&#39;SumOfPrecipitations&#39;</span><span class="p">,</span> <span class="s1">&#39;Month&#39;</span><span class="p">]]</span>
<span class="n">df_climateData</span><span class="p">[</span><span class="s1">&#39;PAR_umol/m2/s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gam</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="c1"># Careful about the units ! We formatted the input data of the GAM for umol/m2/s, the default unit in PnET</span>
<span class="n">df_climateData</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;ReferencesAndData/dataFrameClimate.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Outputing a diagnostic plot for the first location in the data of CanLEADv1 versus the average data we&#39;ve done for CanDSC-M6 data</span>
<span class="n">location</span> <span class="o">=</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][[</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">]]</span>
<span class="n">location_data_CanLEADv1</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[(</span><span class="n">merged_df</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">location</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">])</span> <span class="o">&amp;</span> 
                          <span class="p">(</span><span class="n">merged_df</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">location</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">])]</span>
<span class="c1"># We add a time column to CanDCS-M6 data</span>
<span class="n">df_climateData</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_climateData</span><span class="p">[</span><span class="s2">&quot;Year&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">df_climateData</span><span class="p">[</span><span class="s2">&quot;Month&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;-01&quot;</span>

<span class="n">lengthOfData</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_climateData</span><span class="p">[</span><span class="s1">&#39;PAR_umol/m2/s&#39;</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">location_data_CanLEADv1</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">lengthOfData</span><span class="p">],</span> <span class="n">location_data_CanLEADv1</span><span class="p">[</span><span class="s1">&#39;rsdsAdjust&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">lengthOfData</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Actual RSDS in CanLEADv1 at location&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">location_data_CanLEADv1</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">lengthOfData</span><span class="p">],</span> <span class="n">location_data_CanLEADv1</span><span class="p">[</span><span class="s1">&#39;rsds_pred&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">lengthOfData</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predicted RSDS from CanLEADv1 temperature and precipitation at location&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="c1"># We use the same time data as CanLEADv1, as the measurements are for the exact same months anyway.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">location_data_CanLEADv1</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">lengthOfData</span><span class="p">],</span> <span class="n">df_climateData</span><span class="p">[</span><span class="s1">&#39;PAR_umol/m2/s&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predicted RSDS from CanDCS-M6 temperature and precipitation (averaged on the landscape)&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;RSDS (W/m²)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Actual vs Predicted RSDS at Lat: </span><span class="si">{</span><span class="n">location</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">, Lon: </span><span class="si">{</span><span class="n">location</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e68d13c9a50950c2d364c6835044bc1cd4b2eeeedb3720d1bcd08ad7b46189a0.png" src="../_images/e68d13c9a50950c2d364c6835044bc1cd4b2eeeedb3720d1bcd08ad7b46189a0.png" />
</div>
</div>
<p>The predicted values show a really good fit on both CanLEADv1 (the training data) and CanDCS-M6 data. The seasonal variance, along with the year to year variance in the high and lows seem to be conserved really well.</p>
<p>I’m certain that other approaches can be even better, but that will do great for calibration purposes.</p>
<p>As such, we end up with a data frame containing Precipitations, Tmin, Tmax and Par for historical (1950-2010) data, with precipitations, Tmin and Tmax coming from the model closest to the concensus in CanDCS-M6 (see above), and PAR coming from a statistical model trained on CanLEADv1 data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;ReferencesAndData/dataFrameClimate.csv&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     Year  Month       Tmax       Tmin  SumOfPrecipitations  PAR_umol/m2/s
0    1950      1   1.766656 -40.488547            82.018227     270.510895
1    1950      2   3.891656 -30.540625           121.325523     401.440252
2    1950      3   7.339594 -32.717703            53.020832     670.449927
3    1950      4  22.693750 -14.910406            68.468750     862.178207
4    1950      5  28.860406  -6.858344            51.800781    1054.423142
..    ...    ...        ...        ...                  ...            ...
727  2010      8  30.714594   5.745844            59.013020     922.042915
728  2010      9  26.756250   0.412500            78.882812     620.712206
729  2010     10  25.725000  -6.327094            81.093750     412.238905
730  2010     11  12.475000 -14.025000            73.684898     232.457689
731  2010     12   8.402094 -23.025000            77.760414     185.960717

[732 rows x 6 columns]
</pre></div>
</div>
</div>
</div>
</section>
<section id="climate-source-for-co2-concentrations">
<h3>Climate source for ☁️ CO2 concentrations<a class="headerlink" href="#climate-source-for-co2-concentrations" title="Link to this heading">#</a></h3>
<p>While there are local variations around the atmosphere in CO2 concentrations (see <a class="reference external" href="https://earthobservatory.nasa.gov/images/82142/global-patterns-of-carbon-dioxide">here</a>), the differences are small, and it seems like global values can be used (see <a class="reference external" href="https://earthobservatory.nasa.gov/blogs/earthmatters/2016/12/05/reader-question-does-co2-disperse-evenly-around-the-earth/">here</a>).</p>
<p>Data from <a class="reference external" href="https://www.nature.com/articles/s41597-022-01196-7#Sec5">https://www.nature.com/articles/s41597-022-01196-7#Sec5</a> seems very promising : available at <a class="reference external" href="https://zenodo.org/records/5021361">https://zenodo.org/records/5021361</a>, not too big, allows for local variations in CO2 concentration. Would need to script the download and treatment of the files here. Timestep is already monthly. Goes to 2150, so perfect for our uses.</p>
<p>Justification for using the dataset :</p>
<ul class="simple">
<li><p>We know that this CO2 dataset does not come from the same GCM that generated our climate data, and there could be variability between the variability of climate variables in one dataset versus the climate variables in the models that generated these CO2 estimates at each given timestep.</p></li>
<li><p>However, We thought it better to use this dataset to approximate CO2 spatial and temporal variations in our simulations rather than using latitudinal or global averages.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># First, we download the CO2 data from https://zenodo.org/records/5021361 </span>

<span class="kn">from</span><span class="w"> </span><span class="nn">functionsForCalibration</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">urllib.request</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="c1"># We use the zenodo_get library to download files from Zenodo very fast; other methods tend to be slow.</span>
<span class="c1"># See https://github.com/dvolgyes/zenodo_get . It is installed in the Docker image.</span>
<span class="c1"># WARNING : will take around 1.5GB of space for the data from 1950 to 2150 for a full climate scenario.</span>

<span class="c1"># We download the file with historical data</span>
<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;cd ReferencesAndData &amp;&amp; zenodo_get 5021361 -g CO2_1deg_month_1850-2013.nc&quot;</span><span class="p">)</span>

<span class="c1"># Then, we download the file with future data</span>
<span class="c1"># Not needed here since we&#39;re working with historical data only, but can be re-used in the future</span>
<span class="c1"># os.system(&quot;cd ReferencesAndData &amp;&amp; zenodo_get 5021361 -g CO2_SSP126_2015_2150.nc&quot;)</span>

<span class="c1"># We download the .nc files</span>

<span class="c1"># WARNING : Download from Zenodo seems to be relatively slow, even with a good connection. Expect at least 20min of download.</span>
<span class="c1"># urllib.request.urlretrieve(&quot;https://zenodo.org/records/5021361/files/CO2_1deg_month_1850-2013.nc?download=1&quot;,</span>
                           <span class="c1"># &quot;./ReferencesAndData/CO2_1deg_month_1850-2013.nc&quot;,</span>
                          <span class="c1"># reporthook=progress_hook)</span>

<span class="c1"># urllib.request.urlretrieve(&quot;https://zenodo.org/records/5021361/files/CO2_SSP126_2015_2150.nc?download=1&quot;,</span>
                           <span class="c1"># &quot;./ReferencesAndData/CO2_SSP126_2015_2150.nc&quot;,</span>
                          <span class="c1"># reporthook=progress_hook)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Title: Global monthly distributions of atmospheric CO2 concentrations under the historical and future scenarios
Keywords: Atmospheric chemistry, Atmospheric dynamics, Climate and Earth system modelling
Publication date: 2021-06-23
DOI: 10.5281/zenodo.5021361
Total size: 1.0 GB

Link: https://zenodo.org/records/5021361/files/CO2_1deg_month_1850-2013.nc   size: 1.0 GB
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Checksum is correct. (b11db6cc374ce23fd41b3b078cc8ebdd)
All files have been downloaded.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">functionsForCalibration</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="n">historical_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="s2">&quot;./ReferencesAndData/CO2_1deg_month_1850-2013.nc&quot;</span><span class="p">)</span>
<span class="c1"># future_ds = xr.open_dataset(&quot;./ReferencesAndData/CO2_SSP126_2015_2150.nc&quot;)</span>
<span class="c1"># To use the same functions that we used before for temperature and precipitation, we have to standardize the dataset</span>
<span class="c1"># Because it uses latitude and longitude as variables rather than coordinates.</span>
<span class="c1"># historical_ds = standardize_xarray_dataset(historical_ds)</span>
<span class="c1"># future_ds = standardize_xarray_dataset(future_ds)</span>

<span class="c1"># We load the dataframe</span>
<span class="n">df_climate</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;./ReferencesAndData/dataFrameClimate.csv&quot;</span><span class="p">)</span>

<span class="c1"># Paths to the files</span>
<span class="n">shapefile</span> <span class="o">=</span> <span class="s2">&quot;./ReferencesAndData/ChapleauBoundariesClimate.shp&quot;</span>

<span class="c1"># historical_ds</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Process the data and fill the dataframe</span>
<span class="c1"># Function is in functionsForCalibration.py</span>
<span class="n">df_climate</span> <span class="o">=</span> <span class="n">process_co2_data</span><span class="p">(</span><span class="n">historical_ds</span><span class="p">,</span> <span class="n">shapefile</span><span class="p">,</span> <span class="n">df_climate</span><span class="p">)</span>

<span class="c1"># Display the updated dataframe</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_climate</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>

<span class="c1"># Plot CO2 concentration over time</span>
<span class="c1"># plt.figure(figsize=(12, 6))</span>
<span class="c1"># yearly_avg = df_climate.groupby(&#39;Year&#39;)[&#39;CO2_Concentration&#39;].mean()</span>
<span class="c1"># plt.plot(yearly_avg.index, yearly_avg.values)</span>
<span class="c1"># plt.title(&#39;Average CO2 Concentration Over Time&#39;)</span>
<span class="c1"># plt.xlabel(&#39;Year&#39;)</span>
<span class="c1"># plt.ylabel(&#39;CO2 Concentration (ppm)&#39;)</span>
<span class="c1"># plt.grid(True)</span>
<span class="c1"># plt.savefig(&#39;co2_concentration_trend.png&#39;)</span>
<span class="c1"># plt.show()</span>

<span class="c1"># We update the data frame file</span>
<span class="n">df_climate</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;./ReferencesAndData/dataFrameClimate.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

<span class="c1"># We delete the climate files once it&#39;s over to free up space</span>
<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;./ReferencesAndData/CO2_1deg_month_1850-2013.nc&quot;</span><span class="p">)</span>
<span class="c1"># os.remove(&quot;./ReferencesAndData/CO2_SSP126_2015_2150.nc&quot;)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>No points found inside the polygon for historical data. Finding closest point...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Closest point to polygon centroid for historical data: Lon=-83.5, Lat=47.5
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   Year  Month       Tmax       Tmin  SumOfPrecipitations  PAR_umol/m2/s  \
0  1950      1   1.766656 -40.488547            82.018227     270.510895   
1  1950      2   3.891656 -30.540625           121.325523     401.440252   
2  1950      3   7.339594 -32.717703            53.020832     670.449927   
3  1950      4  22.693750 -14.910406            68.468750     862.178207   
4  1950      5  28.860406  -6.858344            51.800781    1054.423142   

   CO2_Concentration  
0         317.369324  
1         317.919434  
2         318.526337  
3         316.885101  
4         313.878418  
     Year  Month       Tmax       Tmin  SumOfPrecipitations  PAR_umol/m2/s  \
727  2010      8  30.714594   5.745844            59.013020     922.042915   
728  2010      9  26.756250   0.412500            78.882812     620.712206   
729  2010     10  25.725000  -6.327094            81.093750     412.238905   
730  2010     11  12.475000 -14.025000            73.684898     232.457689   
731  2010     12   8.402094 -23.025000            77.760414     185.960717   

     CO2_Concentration  
727         386.168488  
728         391.924408  
729         396.349762  
730         398.554047  
731         399.926788  
</pre></div>
</div>
</div>
</div>
</section>
<section id="averaging-climate-data-in-constant-historical-averages">
<h3>Averaging climate data in constant historical averages<a class="headerlink" href="#averaging-climate-data-in-constant-historical-averages" title="Link to this heading">#</a></h3>
<p>As said at the beginning, <a class="reference download internal" download="" href="../_downloads/0c3667e495cffb2731d2820363988a43/Gustafson2024PnETUserGuide.pdf"><span class="xref download myst">Gustafson and Miranda (2023)</span></a> recommends using a constant climate for calibrating (p. 69). Therefore, we are going to transform our climate data from a monthly year-by-year data into 12 values of historical averages for each months.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="n">df_climate</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;./ReferencesAndData/dataFrameClimate.csv&quot;</span><span class="p">)</span>

<span class="n">monthly_avg</span> <span class="o">=</span> <span class="n">df_climate</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Month&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span>
    <span class="s1">&#39;Tmax&#39;</span><span class="p">:</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Tmin&#39;</span><span class="p">:</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SumOfPrecipitations&#39;</span><span class="p">:</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span>
    <span class="s1">&#39;PAR_umol/m2/s&#39;</span><span class="p">:</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CO2_Concentration&#39;</span> <span class="p">:</span> <span class="s1">&#39;mean&#39;</span>
<span class="p">})</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

<span class="c1"># Add a Year column with the range of years</span>
<span class="n">min_year</span> <span class="o">=</span> <span class="n">df_climate</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
<span class="n">max_year</span> <span class="o">=</span> <span class="n">df_climate</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="n">monthly_avg</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">min_year</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">max_year</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="c1"># Reorder columns to match the desired output</span>
<span class="n">monthly_avg</span> <span class="o">=</span> <span class="n">monthly_avg</span><span class="p">[[</span><span class="s1">&#39;Year&#39;</span><span class="p">,</span> <span class="s1">&#39;Month&#39;</span><span class="p">,</span> <span class="s1">&#39;Tmax&#39;</span><span class="p">,</span> <span class="s1">&#39;Tmin&#39;</span><span class="p">,</span> <span class="s1">&#39;PAR_umol/m2/s&#39;</span><span class="p">,</span> <span class="s1">&#39;SumOfPrecipitations&#39;</span><span class="p">,</span> <span class="s1">&#39;CO2_Concentration&#39;</span><span class="p">]]</span>

<span class="c1"># Display the result</span>
<span class="nb">print</span><span class="p">(</span><span class="n">monthly_avg</span><span class="p">)</span>

<span class="c1"># Export to new file</span>
<span class="n">monthly_avg</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;./ReferencesAndData/dataFrameClimate_historicalAverage.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>         Year  Month       Tmax       Tmin  PAR_umol/m2/s  \
0   1950-2010      1   0.737464 -36.896498     271.636886   
1   1950-2010      2   3.655669 -35.664175     447.422742   
2   1950-2010      3  10.778963 -30.476673     666.168402   
3   1950-2010      4  19.205361 -17.522951     886.976261   
4   1950-2010      5  27.262398  -5.332206    1016.673341   
5   1950-2010      6  29.237466  -0.112261    1036.693091   
6   1950-2010      7  29.977732   3.811920    1035.283419   
7   1950-2010      8  28.259153   2.469024     878.605910   
8   1950-2010      9  25.260178  -2.407344     601.087783   
9   1950-2010     10  20.470730  -7.518171     393.313548   
10  1950-2010     11  10.695115 -19.211901     237.569868   
11  1950-2010     12   3.242077 -31.874726     208.661801   

    SumOfPrecipitations  CO2_Concentration  
0             73.912942         347.781625  
1             58.297990         348.370057  
2             64.171854         348.695298  
3             58.614002         346.613010  
4             70.851109         343.331045  
5             91.549233         338.369620  
6             78.208632         335.384078  
7             81.303790         337.210632  
8             98.216380         341.524782  
9             86.386377         345.212900  
10            86.910722         347.312142  
11            73.884520         348.456925  
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./StartingCalibrationTest"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="3.Initial_Species_Parameters.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Initial species parameters</p>
      </div>
    </a>
    <a class="right-next"
       href="5.Obtaining_Growth_data_from_FVS.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Obtaining the growth data from the Forest Vegetation Simulator that will serve as reference for the calibration</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-climate-file">The climate file</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#climate-data-location-for-the-calibration">Climate data location for the calibration</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#climate-data-source-for-temperature-and-precipitation">Climate data source for 🌡️ temperature and 🌧️ precipitation</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#extraction-of-temperature-and-precipitation-data-for-ontario-1950-2100-from-candsc-m6">Extraction of 🌡 temperature and 🌧 precipitation data for Ontario, 1950-2100 from CanDSC-M6</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#climate-data-source-for-par-photosynthetically-active-radiation">Climate data source for ☀ PAR (Photosynthetically Active Radiation)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#climate-source-for-co2-concentrations">Climate source for ☁️ CO2 concentrations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#averaging-climate-data-in-constant-historical-averages">Averaging climate data in constant historical averages</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Clément Hardy, PhD
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>